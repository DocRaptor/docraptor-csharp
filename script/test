#!/bin/sh
set -ex
cd "`dirname \"$0\"`/.."

MINIMAL_DOCRAPTOR_LIB="build/docraptor-minimal.dll"
EVERYTHING_DOCRAPTOR_LIB="build/docraptor-all.dll"

mcs -lib:bin -reference:Newtonsoft.Json.dll,RestSharp.dll,System.Runtime.Serialization.dll -target:library -out:$MINIMAL_DOCRAPTOR_LIB -recurse:src/*.cs

mono test/ILRepack.exe /internalize /out:$EVERYTHING_DOCRAPTOR_LIB $MINIMAL_DOCRAPTOR_LIB bin/*.dll

cp $EVERYTHING_DOCRAPTOR_LIB test

compile_and_run() {
  base_name=`basename -s .cs $1`
  mcs -lib:build/ -reference:docraptor-all.dll test/$base_name.cs -out:test/$base_name.exe
  mono test/$base_name.exe
}

if [ "$1" == "" ]; then
  for test in $(ls test/*.cs); do
    compile_and_run $test
  done
else
  compile_and_run $1.cs
fi
